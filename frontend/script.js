stations = {
    "0001": {
        "name": "S Hennigsdorf",
        "location": [52.63736,13.20607],
        "tariff": "C"
    },
    "0002": {
        "name": "S Heiligensee",
        "location": [52.62466,13.22919],
        "tariff": "B"
    },
    "0003": {
        "name": "S Schulzendorf",
        "location": [52.61291,13.24601],
        "tariff": "B"
    },
    "0004": {
        "name": "S Tegel",
        "location": [52.58819,13.28966],
        "tariff": "B"
    },
    "0005": {
        "name": "S Eichborndamm",
        "location": [52.57762,13.31661],
        "tariff": "B"
    },
    "0006": {
        "name": "S Karl-Bonhoeffer-Nervenklinik",
        "location": [52.57801,13.32917],
        "tariff": "B"
    },
    "0007": {
        "name": "S Alt-Reinickendorf",
        "location": [52.57778,13.35125],
        "tariff": "B"
    },
    "0008": {
        "name": "S Schönholz",
        "location": [52.57149,13.38100],
        "tariff": "B"
    },
    "0009": {
        "name": "S Wollankstraße",
        "location": [52.56515,13.39236],
        "tariff": "B"
    },
    "0010": {
        "name": "S Bornholmer Straße",
        "location": [52.55477,13.39784],
        "tariff": "B"
    },
    "0011": {
        "name": "S Gesundbrunnen",
        "location": [52.54917,13.39007],
        "tariff": "A"
    },
    "0012": {
        "name": "S Humboldthain",
        "location": [52.54495,13.37946],
        "tariff": "A"
    },
    "0013": {
        "name": "S Nordbahnhof",
        "location": [52.53227,13.38784],
        "tariff": "A"
    },
    "0014": {
        "name": "S Oranienburger Straße",
        "location": [52.52523,13.39301],
        "tariff": "A"
    },
    "0015": {
        "name": "S Friedrichstraße",
        "location": [52.52050,13.38682],
        "tariff": "A"
    },
    "0016": {
        "name": "S Brandenburger Tor",
        "location": [52.51644,13.38184],
        "tariff": "A"
    },
    "0017": {
        "name": "S Potsdamer Platz",
        "location": [52.50941,13.37664],
        "tariff": "A"
    },
    "0018": {
        "name": "S Anhalter Bahnhof",
        "location": [52.50358,13.38147],
        "tariff": "A"
    },
    "0019": {
        "name": "S Yorckstraße",
        "location": [52.49207,13.37215],
        "tariff": "A"
    },
    "0020": {
        "name": "Berlin Südkreuz",
        "location": [52.47657,13.36604],
        "tariff": "A"
    },
    "0021": {
        "name": "S Priesterweg",
        "location": [52.45992,13.35626],
        "tariff": "B"
    },
    "0022": {
        "name": "S Südende",
        "location": [52.44828,13.35375],
        "tariff": "B"
    },
    "0023": {
        "name": "S Lankwitz",
        "location": [52.43878,13.34207],
        "tariff": "B"
    },
    "0024": {
        "name": "S Lichterfelde Ost",
        "location": [52.42986,13.32809],
        "tariff": "B"
    },
    "0025": {
        "name": "S Osdorfer Straße",
        "location": [52.41887,13.31424],
        "tariff": "B"
    },
    "0026": {
        "name": "S Lichterfelde Süd",
        "location": [52.40996,13.30855],
        "tariff": "B"
    },
    "0027": {
        "name": "S Teltow Stadt",
        "location": [52.39685,13.27625],
        "tariff": "C"
    },
    "0028": {
        "name": "S Bernau",
        "location": [52.67555,13.59172],
        "tariff": "C"
    },
    "0029": {
        "name": "S Bernau-Friedenstal",
        "location": [52.66840,13.56461],
        "tariff": "C"
    },
    "0030": {
        "name": "S Zepernick",
        "location": [52.65968,13.53385],
        "tariff": "C"
    },
    "0031": {
        "name": "S Röntgental",
        "location": [52.64868,13.51360],
        "tariff": "C"
    },
    "0032": {
        "name": "S Buch",
        "location": [52.63583,13.49163],
        "tariff": "B"
    },
    "0033": {
        "name": "S Karow",
        "location": [52.61521,13.46946],
        "tariff": "B"
    },
    "0034": {
        "name": "S Blankenburg",
        "location": [52.59147,13.44348],
        "tariff": "B"
    },
    "0035": {
        "name": "S Pankow-Heinersdorf",
        "location": [52.57806,13.42950],
        "tariff": "B"
    },
    "0036": {
        "name": "S Pankow",
        "location": [52.56627,13.41034],
        "tariff": "A"
    },
    "0037": {
        "name": "S Attilastraße",
        "location": [52.44803,13.36075],
        "tariff": "B"
    },
    "0038": {
        "name": "S Marienfelde",
        "location": [52.42422,13.37469],
        "tariff": "B"
    },
    "0039": {
        "name": "S Buckower Chausee",
        "location": [52.41055,13.38277],
        "tariff": "B"
    },
    "0040": {
        "name": "S Schichauweg",
        "location": [52.39854,13.38940],
        "tariff": "B"
    },
    "0041": {
        "name": "S Lichtenrade",
        "location": [52.38728,13.39649],
        "tariff": "B"
    },
    "0042": {
        "name": "S Mahlow",
        "location": [52.36063,13.40783],
        "tariff": "C"
    },
    "0043": {
        "name": "S Blankenfelde",
        "location": [52.33844,13.41539],
        "tariff": "C"
    },
    "0044": {
        "name": "S Waidmannslust",
        "location": [52.60627,13.32120],
        "tariff": "B"
    },
    "0045": {
        "name": "S Wittenau",
        "location": [52.59705,13.33426],
        "tariff": "B"
    },
    "0046": {
        "name": "S Wilhelmsruh",
        "location": [52.58170,13.36224],
        "tariff": "B"
    },
    "0047": {
        "name": "S Oranienburg",
        "location": [52.75397,13.24891],
        "tariff": "C"
    },
    "0048": {
        "name": "S Lehnitz",
        "location": [52.74139,13.26319],
        "tariff": "C"
    },
    "0049": {
        "name": "S Borgsdorf",
        "location": [52.71540,13.27647],
        "tariff": "C"
    },
    "0050": {
        "name": "S Birkenwerder",
        "location": [52.68866,13.28870],
        "tariff": "C"
    },
    "0051": {
        "name": "S Hohen Neuendorf",
        "location": [52.66865,13.28704],
        "tariff": "C"
    },
    "0052": {
        "name": "S Frohnau",
        "location": [52.63241,13.29022],
        "tariff": "B"
    },
    "0053": {
        "name": "S Hermsdorf",
        "location": [52.61745,13.30752],
        "tariff": "B"
    },
    "0054": {
        "name": "S Yorckstraße (Großgörschenstraße)",
        "location": [52.49227,13.36786],
        "tariff": "A"
    },
    "0055": {
        "name": "S Julius-Leber-Brücke",
        "location": [52.48650,13.36117],
        "tariff": "A"
    },
    "0056": {
        "name": "S Schöneberg",
        "location": [52.47935,13.35192],
        "tariff": "A"
    },
    "0057": {
        "name": "S Friedenau",
        "location": [52.47071,13.34150],
        "tariff": "B"
    },
    "0058": {
        "name": "S Feuerbachstraße",
        "location": [52.46368,13.33270],
        "tariff": "B"
    },
    "0059": {
        "name": "S Rathaus Steglitz",
        "location": [52.45553,13.32251],
        "tariff": "B"
    },
    "0060": {
        "name": "S Botanischer Garten",
        "location": [52.44796,13.30713],
        "tariff": "B"
    },
    "0061": {
        "name": "S Lichterfelde West",
        "location": [52.44331,13.29358],
        "tariff": "B"
    },
    "0062": {
        "name": "S Sundgauer Straße",
        "location": [52.43644,13.27419],
        "tariff": "B"
    },
    "0063": {
        "name": "S Zehlendorf",
        "location": [52.43107,13.25857],
        "tariff": "B"
    },
    "0064": {
        "name": "S Mexikoplatz",
        "location": [52.43677,13.23324],
        "tariff": "B"
    },
    "0065": {
        "name": "S Schlachtensee",
        "location": [52.44009,13.21544],
        "tariff": "B"
    },
    "0066": {
        "name": "S Nikolassee",
        "location": [52.43206,13.19316],
        "tariff": "B"
    },
    "0067": {
        "name": "S Wannsee",
        "location": [52.42141,13.17981],
        "tariff": "B"
    },
    "0068": {
        "name": "S Spandau",
        "location": [52.53477,13.19745],
        "tariff": "B"
    },
    "0069": {
        "name": "S Stresow",
        "location": [52.53194,13.20935],
        "tariff": "B"
    },
    "0070": {
        "name": "S Pichelsberg",
        "location": [52.51015,13.22763],
        "tariff": "B"
    },
    "0071": {
        "name": "S Olympiastadion",
        "location": [52.51126,13.24283],
        "tariff": "B"
    },
    "0072": {
        "name": "S Heerstraße",
        "location": [52.50785,13.25986],
        "tariff": "B"
    },
    "0073": {
        "name": "S Messe Süd (Eichkamp)",
        "location": [52.49864,13.27023],
        "tariff": "B"
    },
    "0074": {
        "name": "S Westkreuz",
        "location": [52.50079,13.28392],
        "tariff": "A"
    },
    "0075": {
        "name": "S Charlottenburg",
        "location": [52.50505,13.30451],
        "tariff": "A"
    },
    "0076": {
        "name": "S Savignyplatz",
        "location": [52.50517,13.31906],
        "tariff": "A"
    },
    "0077": {
        "name": "S Zoologischer Garten",
        "location": [52.50713,13.33187],
        "tariff": "A"
    },
    "0078": {
        "name": "S Tiergarten",
        "location": [52.51438,13.33645],
        "tariff": "A"
    },
    "0079": {
        "name": "S Bellevue",
        "location": [52.51998,13.34807],
        "tariff": "A"
    },
    "0080": {
        "name": "S Hauptbahnhof",
        "location": [52.52519,13.36933],
        "tariff": "A"
    },
    "0081": {
        "name": "S Hackescher Markt",
        "location": [52.52268,13.40234],
        "tariff": "A"
    },
    "0082": {
        "name": "S Alexanderplatz",
        "location": [52.52157,13.41128],
        "tariff": "A"
    },
    "0083": {
        "name": "S Jannowitzbrücke",
        "location": [52.51421,13.41949],
        "tariff": "A"
    },
    "0084": {
        "name": "S Ostbahnhof",
        "location": [52.51074,13.43517],
        "tariff": "A"
    },
    "0085": {
        "name": "S Warschauer Straße",
        "location": [52.50637,13.45011],
        "tariff": "A"
    },
    "0086": {
        "name": "S Ostkreuz",
        "location": [52.50315,13.46958],
        "tariff": "A"
    },
    "0087": {
        "name": "S Rummelsburg",
        "location": [52.50127,13.47840],
        "tariff": "B"
    },
    "0088": {
        "name": "S Betriebsbahnhof Rummelsburg",
        "location": [52.49388,13.49773],
        "tariff": "B"
    },
    "0089": {
        "name": "S Karlshorst",
        "location": [52.48047,13.52728],
        "tariff": "B"
    },
    "0090": {
        "name": "S Wuhlheide",
        "location": [52.46855,13.55433],
        "tariff": "B"
    },
    "0091": {
        "name": "S Köpenick",
        "location": [52.45857,13.58152],
        "tariff": "B"
    },
    "0092": {
        "name": "S Hirschgarten",
        "location": [52.45791,13.60314],
        "tariff": "B"
    },
    "0093": {
        "name": "S Friedrichshagen",
        "location": [52.45737,13.62329],
        "tariff": "B"
    },
    "0094": {
        "name": "S Rahnsdorf",
        "location": [52.45163,13.68998],
        "tariff": "B"
    },
    "0095": {
        "name": "S Wilhelmshagen",
        "location": [52.43849,13.72233],
        "tariff": "B"
    },
    "0096": {
        "name": "S Erkner",
        "location": [52.42942,13.75106],
        "tariff": "C"
    },
    "0097": {
        "name": "S Schönhauser Allee",
        "location": [52.54924,13.41560],
        "tariff": "A"
    },
    "0098": {
        "name": "S Prenzlauer Allee",
        "location": [52.54479,13.42597],
        "tariff": "A"
    },
    "0099": {
        "name": "S Greifswalder Straße",
        "location": [52.54024,13.43899],
        "tariff": "A"
    },
    "0100": {
        "name": "S Landberger Allee",
        "location": [52.52948,13.45478],
        "tariff": "A"
    },
    "0101": {
        "name": "S Storkower Straße",
        "location": [52.52374,13.46489],
        "tariff": "A"
    },
    "0102": {
        "name": "S Frankfurter Allee",
        "location": [52.51493,13.47457],
        "tariff": "A"
    },
    "0103": {
        "name": "S Treptower Park",
        "location": [52.49385,13.46183],
        "tariff": "A"
    },
    "0104": {
        "name": "S Sonnenallee",
        "location": [52.47298,13.45569],
        "tariff": "A"
    },
    "0105": {
        "name": "S Neukölln",
        "location": [52.46951,13.44375],
        "tariff": "A"
    },
    "0106": {
        "name": "S Hermannstraße",
        "location": [52.46763,13.43124],
        "tariff": "A"
    },
    "0107": {
        "name": "S Tempelhof",
        "location": [52.47097,13.38444],
        "tariff": "A"
    },
    "0108": {
        "name": "S Innsbrucker Platz",
        "location": [52.47810,13.34154],
        "tariff": "A"
    },
    "0109": {
        "name": "S Bundesplatz",
        "location": [52.47765,13.32955],
        "tariff": "A"
    },
    "0110": {
        "name": "S Heidelberger Platz",
        "location": [52.48029,13.31143],
        "tariff": "A"
    },
    "0111": {
        "name": "S Hohenzollerndamm",
        "location": [52.48863,13.30024],
        "tariff": "A"
    },
    "0112": {
        "name": "S Halensee",
        "location": [52.49602,13.29056],
        "tariff": "A"
    },
    "0113": {
        "name": "S Messe Nord / ICC",
        "location": [52.50771,13.28347],
        "tariff": "A"
    },
    "0114": {
        "name": "S Westend",
        "location": [52.51801,13.28442],
        "tariff": "A"
    },
    "0115": {
        "name": "S Jungfernheide",
        "location": [52.53040,13.29927],
        "tariff": "A"
    },
    "0116": {
        "name": "S Beusselstraße",
        "location": [52.53440,13.32939],
        "tariff": "A"
    },
    "0117": {
        "name": "S Westhafen",
        "location": [52.53628,13.34442],
        "tariff": "A"
    },
    "0118": {
        "name": "S Wedding",
        "location": [52.54279,13.36700],
        "tariff": "A"
    }
}

// öüß

sbahnen = {
    "s1": [
        "0047",
        "0048",
        "0049",
        "0050",
        "0051",
        "0052",
        "0053",
        "0044",
        "0045",
        "0046",
        "0008",
        "0009",
        "0010",
        "0011",
        "0012",
        "0013",
        "0014",
        "0015",
        "0016",
        "0017",
        "0018",
        "0054",
        "0055",
        "0056",
        "0057",
        "0058",
        "0059",
        "0060",
        "0061",
        "0062",
        "0063",
        "0064",
        "0065",
        "0066",
        "0067"
    ],
    "s2": [
        "0028",
        "0029",
        "0030",
        "0031",
        "0032",
        "0033",
        "0034",
        "0035",
        "0036",
        "0010",
        "0011",
        "0012",
        "0013",
        "0014",
        "0015",
        "0016",
        "0017",
        "0018",
        "0019",
        "0020",
        "0021",
        "0037",
        "0038",
        "0039",
        "0040",
        "0041",
        "0042",
        "0043"
    ],
    "s25": [
        "0001",
        "0002",
        "0003",
        "0004",
        "0005",
        "0006",
        "0007",
        "0008",
        "0009",
        "0010",
        "0011",
        "0012",
        "0013",
        "0014",
        "0015",
        "0016",
        "0017",
        "0018",
        "0019",
        "0020",
        "0021",
        "0022",
        "0023",
        "0024",
        "0025",
        "0026",
        "0026",
        "0027"
    ],
    "s26": [
        "0044",
        "0045",
        "0046",
        "0008",
        "0009",
        "0010",
        "0011",
        "0012",
        "0013",
        "0014",
        "0015",
        "0016",
        "0017",
        "0018",
        "0019",
        "0020",
        "0021",
        "0022",
        "0023",
        "0024",
        "0025",
        "0026",
        "0026",
        "0027"
    ],
    "s3": [
        "0068",
        "0069",
        "0070",
        "0071",
        "0072",
        "0073",
        "0074",
        "0075",
        "0076",
        "0077",
        "0078",
        "0079",
        "0080",
        "0015",
        "0081",
        "0082",
        "0083",
        "0084",
        "0085",
        "0086",
        "0087",
        "0088",
        "0090",
        "0091",
        "0092",
        "0093",
        "0094",
        "0095",
        "0096"
    ],
    "s41": [
        "0011",
        "0097",
        "0098",
        "0099",
        "0100",
        "0101",
        "0102",
        "0086",
        "0103",
        "0104",
        "0105",
        "0106",
        "0107",
        "0020",
        "0056",
        "0108",
        "0109",
        "0110",
        "0111",
        "0112",
        "0074",
        "0113",
        "0114",
        "0115",
        "0116",
        "0117",
        "0118",
        "0011"
    ]
}

colors = {
    "s1": ''
}

sbahnen.s42 = sbahnen.s41

var map = L.map('mapid').setView([52.5146, 13.3881], 14);

function makePolyLine(stationIds) {
    points = [];

    for (let i = 0; i < stationIds.length; i++) {
        points.push(stations[stationIds[i]].location)
    }

    return points;
}

function makeRingPolyLine(stationIds, color1, color2) {
    color = 0
    colors = [color1, color2]

    for (let i = 1; i < stationIds.length; i++) {
        lineSegmentCW = [];
        lineSegmentCW.push(stations[stationIds[i - 1]].location);
        lineSegmentCW.push(stations[stationIds[i]].location);

        lineSegmentCCW = [];
        lineSegmentCCW.push(stations[stationIds[i]].location);
        lineSegmentCCW.push(stations[stationIds[i - 1]].location);

        L.polyline([
            stations[stationIds[i - 1]].location,
            stations[stationIds[i]].location
        ], {
            color: colors[color],
            weight: 5
        }).addTo(map);
        if (color == 0)
            color = 1;
        else
            color = 0;
    }
}

function rotateVector(vec, angle) {
    return [
        Math.cos(angle) * vec[0] - Math.sin(angle) * vec[1],
        Math.sin(angle) * vec[0] + Math.cos(angle) * vec[1]
    ];
}

function addVec(vec1, vec2) {
    return [
        vec1[0] + vec2[0],
        vec1[1] + vec2[1]
    ];
}

function subVec(vec1, vec2) {
    return [
        vec1[0] - vec2[0],
        vec1[1] - vec2[1]
    ];
}

function scaleVec(vec, k) {
    return [
        vec[0] * k,
        vec[1] * k
    ];
}

function normalizeVector(vec) {
    return scaleVec(vec, 1 / Math.sqrt(vec[0] * vec[0] + vec[1] * vec[1]));
}

/*
segments = [
    [1, 2],
    [3, 4]
]
*/
function removeOverlap(segments) {
    var newSegments = [];

    let count = segments.length;

    // let movementVec = scaleVec(normalizeVector(rotateVector(addVec([0, segments[0][0]], [0, - segments[0][1]]))), 5 / count);

    for (var i = 0; i < segments.length; i++) {
        let segment = segments[i];

        let dir = subVec(segment[0], segment[1]);

        let angle = Math.atan(dir[1] / dir[0]);

        let facing = Math.floor(angle / (Math.PI / 2)) + 1;
        
        let movementVec = [
            (facing == 1 || facing == 4) ? -5 : 5,
            (facing == 1 || facing == 2) ? -5 : 5
        ];

        let mv = scaleVec(movementVec, 0.0005 / (10 / (count / 2 - i)));

        console.log(mv);

        console.log([
            addVec(segment[0], mv),
            addVec(segment[1], mv)
        ]);

        newSegments.push([
            addVec(segment[0], mv),
            addVec(segment[1], mv)
        ]);
    }

    return newSegments;
}

function makeArr(elem, count) {
    var arr = [];

    for (var i = 0; i < count; i++) {
        arr.push(elem);
    }

    return arr;
}

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

var sbahnIcon = L.icon({
    iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/e/e7/S-Bahn-Logo.svg',
    iconSize: [15, 15]
});

for (const key in stations) {
    L.marker(stations[key].location, {icon: sbahnIcon}).addTo(map).bindPopup(stations[key].name + " (" + stations[key].tariff + ")");
}

allConnections = {}

colors = {
    "s1": "pink",
    "s2": "green",
    "s25": "green",
    "s26": "green",
    "s3": "darkblue",
    "s41": "darkorange",
    "s42": "brown"
}

for (const key in sbahnen) {
    let line = sbahnen[key];

    for (var i = 1; i < line.length; i++) {
        let connName = line[i - 1] + ":" + line[i];

        if (allConnections[connName] == null)
            allConnections[connName] = [];

        allConnections[connName].push(key);
    }
}

let key = "0010:0011";

let bar = removeOverlap(makeArr([stations["0010"].location, stations["0011"].location], 4));

console.log(bar);

for (const foo in bar) {
    L.polyline(bar[foo],
         { color: colors[allConnections[key][foo]],
             weight: 5 })
             .addTo(map);
}

for (const key in allConnections) {
    let ids = key.split(":");
    let start = ids[0];
    let end = ids[1];

    let conns = removeOverlap(makeArr([stations[start].location, stations[end].location], allConnections[key].length));

    for (const line in conns) {
        L.polyline(conns[line], { color: colors[allConnections[key][line]], weight: 5 }).addTo(map);
    }
}

// for (const foo in allConnections[key]) {
//     let ids = key.split(':');
//     let start = ids[0];
//     let end = ids[1];

//     console.log(foo, allConnections[key][foo]);

//     L.polyline([stations[start].location, stations[end].location], { color: colors[allConnections[key][foo]], weight: 5 }).addTo(map);
// }

// for (const conn in allConnections) {
//     let ids = conn.split(':');
//     startId = ids[0];
//     endId = ids[1];

//     if (allConnections[conn].length == 1) {
//         L.polyline([stations[startId].location, stations[endId].location], { color: colors[allConnections[conn][0]], weight: 5.0 }).addTo(map);
//     } else {
//         let connsOR = removeOverlap(makeArr([stations[startId].location, stations[endId].location], allConnections[conn].length));

//         for (var i = 0; i < connsOR.length; i++) {
//             L.polyline(connsOR[i], { color: colors[allConnections[conn][i]], weight: 5}).addTo(map);
//         }
//     }
// }

// L.polyline(makePolyLine(sbahnen.s1), {color: 'pink', weight: 5, smoothFactor: 1.0});
// L.polyline(makePolyLine(sbahnen.s2), {color: 'green', weight: 5, smoothFactor: 1.0});
// L.polyline(makePolyLine(sbahnen.s25), {color: 'green', weight: 5, smoothFactor: 1.0});
// L.polyline(makePolyLine(sbahnen.s26), {color: 'green', weight: 5, smoothFactor: 1.0});
// L.polyline(makePolyLine(sbahnen.s3), {color: 'darkblue', weight: 5, smoothFactor: 1.0});

// makeRingPolyLine(sbahnen.s41, 'darkorange', 'brown');

var popup = L.popup();

map.on('dblclick', function(e) {
    map.doubleClickZoom.disable();

    popup.setLatLng(e.latlng).setContent(e.latlng.toString()).openOn(map);

    setTimeout(() => {
        map.doubleClickZoom.enable();
    }, 1);
});